package com.github.scribejava.apis.fitbit;


import com.github.scribejava.core.model.OAuth2AccessTokenErrorResponse;
import com.github.scribejava.core.model.OAuth2AccessTokenErrorResponse.ErrorCode;
import org.hamcrest.CoreMatchers;
import org.hamcrest.FeatureMatcher;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.ExpectedException;


public class FitBitJsonTokenExtractorTest {
    private static final String ERROR_DESCRIPTION = "Authorization code invalid: " + (("cbb1c11b23209011e89be71201fa6381464dc0af " + "Visit https://dev.fitbit.com/docs/oauth2 for more information ") + "on the Fitbit Web API authorization process.");

    private static final String ERROR_JSON = ("{\"errors\":[{\"errorType\":\"invalid_grant\",\"message\":\"" + (FitBitJsonTokenExtractorTest.ERROR_DESCRIPTION)) + "\"}],\"success\":false}";

    @Rule
    public ExpectedException thrown = ExpectedException.none();

    @Test
    public void testErrorExtraction() {
        final FitBitJsonTokenExtractor extractor = new FitBitJsonTokenExtractor();
        thrown.expect(OAuth2AccessTokenErrorResponse.class);
        thrown.expect(new FitBitJsonTokenExtractorTest.ErrorCodeFeatureMatcher(ErrorCode.invalid_grant));
        thrown.expect(new FitBitJsonTokenExtractorTest.ErrorDescriptionFeatureMatcher(FitBitJsonTokenExtractorTest.ERROR_DESCRIPTION));
        extractor.generateError(FitBitJsonTokenExtractorTest.ERROR_JSON);
    }

    private static class ErrorCodeFeatureMatcher extends FeatureMatcher<OAuth2AccessTokenErrorResponse, ErrorCode> {
        private ErrorCodeFeatureMatcher(ErrorCode expected) {
            super(CoreMatchers.equalTo(expected), "a response with errorCode", "errorCode");
        }

        @Override
        protected ErrorCode featureValueOf(OAuth2AccessTokenErrorResponse actual) {
            return actual.getErrorCode();
        }
    }

    private static class ErrorDescriptionFeatureMatcher extends FeatureMatcher<OAuth2AccessTokenErrorResponse, String> {
        private ErrorDescriptionFeatureMatcher(String expected) {
            super(CoreMatchers.equalTo(expected), "a response with errorDescription", "errorDescription");
        }

        @Override
        protected String featureValueOf(OAuth2AccessTokenErrorResponse actual) {
            return actual.getErrorDescription();
        }
    }
}

